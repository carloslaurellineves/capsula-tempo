<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>C√°psula de Mem√≥rias üíç</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#fafafa; }
    .card { max-width: 520px; margin: 24px auto; background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    h1 { font-size: 1.4rem; margin: 0 0 8px; }
    p { color: #444; line-height: 1.4; }
    label { display:block; font-weight:600; margin-top:12px; }
    input[type="text"], textarea, input[type="file"] { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:1rem; }
    textarea { min-height:80px; }
    button { margin-top:16px; width:100%; padding:12px; border:0; border-radius:12px; font-weight:700; font-size:1rem; background:#111; color:#fff; }
    .ok { padding:10px; background:#e7ffe7; border:1px solid #b6efb6; border-radius:10px; margin-top:14px; }
    .warning { padding:10px; background:#fff4e6; border:1px solid #ffd700; border-radius:10px; margin-top:10px; }
    .note { font-size:.9rem; color:#666; }
    .file-preview { margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; }
    .file-item { margin: 4px 0; color: #666; }
    .upload-summary { margin-top: 10px; font-weight: 600; }
    .failed-file { color: #d32f2f; margin: 4px 0; }
  </style>
</head>
<body>
  <div class="card">
    <h1>C√°psula de Mem√≥rias do nosso casamento üíå</h1>
    <p>Adicione aqui <b>fotos</b> e <b>v√≠deos</b> que voc√™ tenha registrado durante esse dia especial. Assim, colecionaremos mem√≥rias sob olhar de cada um. üì∏ Obrigado! ü•Ç</p>
    <p class="note">üìÅ Voc√™ pode selecionar <strong>m√∫ltiplos arquivos</strong> de uma s√≥ vez. (M√°x: 10 arquivos)</p>

    {% if ok %}
      {% if multiple_files %}
        <div class="ok">
          <div class="upload-summary">
            üéâ Upload conclu√≠do! {{ success_count }} de {{ total_count }} arquivo(s) enviado(s) com sucesso!
          </div>
          <p class="note">Tamanho total: {{ total_size_mb }}MB</p>
          
          {% if uploaded_files %}
            <div class="file-preview">
              <strong>‚úÖ Arquivos enviados:</strong>
              {% for file in uploaded_files %}
                <div class="file-item">
                  ‚Ä¢ {{ file.original_filename }} ({{ "%.1f"|format(file.size_mb) }}MB)
                  {% if file.webViewLink %}
                    <a href="{{ file.webViewLink }}" target="_blank" style="font-size:0.8rem; margin-left:8px;">[ver]</a>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}
          
          {% if failed_files %}
            <div class="warning">
              <strong>‚ö†Ô∏è Alguns arquivos falharam:</strong>
              {% for file in failed_files %}
                <div class="failed-file">‚Ä¢ {{ file.filename }}</div>
              {% endfor %}
              <p class="note">Tente enviar os arquivos que falharam novamente.</p>
            </div>
          {% endif %}
        </div>
      {% else %}
        <!-- Compatibilidade com upload √∫nico antigo -->
        <div class="ok">Recebemos seu arquivo: <b>{{ uploaded_name }}</b>. Obrigado! üíñ</div>
        {% if webViewLink %}
          <p class="note">Link no Drive (p/ organizadores): <a href="{{ webViewLink }}">{{ webViewLink }}</a></p>
        {% endif %}
      {% endif %}
    {% endif %}

    <form method="post" action="/upload" enctype="multipart/form-data">
      <label for="nome">Seu nome</label>
      <input id="nome" name="nome" type="text" placeholder="Ex.: Tia Ana" required />

      <!--<label for="mensagem">Uma mensagem curta (opcional)</label>
      <textarea id="mensagem" name="mensagem" placeholder="Deixem o amor de voc√™s sempre vencer ‚ú®"></textarea>-->

      <label for="files">Arquivos (imagens e v√≠deos)</label>
      <input id="files" name="files" type="file" accept="image/*,video/*,.pdf,.txt,.zip" multiple required />
      <div class="file-preview" id="filePreview" style="display:none;">
        <strong>Arquivos selecionados:</strong>
        <div id="fileList"></div>
        <div id="totalSize" class="note" style="margin-top:8px;"></div>
      </div>

      <label style="display:flex;align-items:center;gap:8px;margin-top:12px;">
        <input type="checkbox" name="consentimento" value="true" required />
        Autorizo os noivos a guardarem e exibirem este conte√∫do para a fam√≠lia.
      </label>

      <button type="submit">Enviar para a C√°psula</button>
      <p class="note">Tamanho m√°x.: {{ max_mb }} MB por arquivo | M√°x: 10 arquivos por envio</p>
    </form>
  </div>
  
  <script>
    // Preview dos arquivos selecionados
    const fileInput = document.getElementById('files');
    const filePreview = document.getElementById('filePreview');
    const fileList = document.getElementById('fileList');
    const totalSize = document.getElementById('totalSize');
    const maxMB = {{ max_mb }};
    const maxFiles = 10;
    
    fileInput.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      
      if (files.length === 0) {
        filePreview.style.display = 'none';
        return;
      }
      
      // Verificar limites
      let warnings = [];
      if (files.length > maxFiles) {
        warnings.push(`M√°ximo ${maxFiles} arquivos permitidos (${files.length} selecionados)`);
      }
      
      let totalSizeBytes = 0;
      let fileListHTML = '';
      
      files.forEach((file, index) => {
        const sizeMB = file.size / (1024 * 1024);
        totalSizeBytes += file.size;
        
        let statusIcon = '‚úÖ';
        if (sizeMB > maxMB) {
          statusIcon = '‚ùå';
          warnings.push(`'${file.name}' excede ${maxMB}MB`);
        }
        
        fileListHTML += `
          <div class="file-item">
            ${statusIcon} ${file.name} (${sizeMB.toFixed(1)}MB)
          </div>
        `;
      });
      
      const totalSizeMB = totalSizeBytes / (1024 * 1024);
      
      fileList.innerHTML = fileListHTML;
      
      let sizeText = `Tamanho total: ${totalSizeMB.toFixed(1)}MB`;
      if (warnings.length > 0) {
        sizeText += ` | ‚ö†Ô∏è ${warnings.join(', ')}`;
        totalSize.style.color = '#d32f2f';
      } else {
        sizeText += ' ‚úÖ';
        totalSize.style.color = '#2e7d32';
      }
      
      totalSize.innerHTML = sizeText;
      filePreview.style.display = 'block';
    });
  </script>
</body>
</html>
